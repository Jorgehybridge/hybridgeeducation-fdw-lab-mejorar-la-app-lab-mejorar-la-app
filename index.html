<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HybridgeFlix</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h1 class="text-2xl font-bold mb-4">HybridgeFlix-Movies</h1>
            <form id="formularioPelicula" class="mb-6">
                <div class="mb-4">
                    <label for="titulo" class="block text-gray-700 font-bold mb-2">Título</label>
                    <input type="text" id="titulo" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-4">
                    <label for="anio" class="block text-gray-700 font-bold mb-2">Año</label>
                    <input type="number" id="anio" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-4">
                    <label for="calificacion" class="block text-gray-700 font-bold mb-2">Calificación (1-10)</label>
                    <input type="number" id="calificacion" min="1" max="10" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-4">
                    <label for="resena" class="block text-gray-700 font-bold mb-2">Reseña</label>
                    <textarea id="resena" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="4" required></textarea>
                </div>
                <button id="btnGuardar" type="button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Guardar</button>
            </form>
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="py-2 px-4 border-b-2 border-gray-300 text-left text-sm font-semibold text-gray-600">Título</th>
                        <th class="py-2 px-4 border-b-2 border-gray-300 text-left text-sm font-semibold text-gray-600">Año</th>
                        <th class="py-2 px-4 border-b-2 border-gray-300 text-left text-sm font-semibold text-gray-600">Calificación</th>
                        <th class="py-2 px-4 border-b-2 border-gray-300 text-left text-sm font-semibold text-gray-600">Reseña</th>
                    </tr>
                </thead>
                <tbody id="cuerpoTablaPeliculas">
                    <!-- Los registros de las películas se añadirán aquí -->
                </tbody>
            </table>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold mb-4">Póster</h2>
            <div id="posterBox" class="flex items-center justify-center h-96 bg-gray-50 border border-dashed rounded">
                <p id="posterStatus" class="text-gray-500 text-center px-4">Escribe el título y el año para ver el póster.</p>
                <img id="posterImage" alt="Póster de la película" class="hidden max-h-96 object-contain" />
            </div>
        </div>
    </div>

    <script>
        function insertarRegistro() {
            const titulo = document.getElementById('titulo').value;
            const anio = document.getElementById('anio').value;
            const calificacion = document.getElementById('calificacion').value;
            const resena = document.getElementById('resena').value;

            const nuevaFila = document.createElement('tr');
            nuevaFila.innerHTML = `
                <td class="py-2 px-4 border-b border-gray-300">${titulo}</td>
                <td class="py-2 px-4 border-b border-gray-300">${anio}</td>
                <td class="py-2 px-4 border-b border-gray-300">${calificacion}</td>
                <td class="py-2 px-4 border-b border-gray-300">${resena}</td>
            `;

            document.getElementById('cuerpoTablaPeliculas').appendChild(nuevaFila);
            document.getElementById('formularioPelicula').reset();
        }

        async function buscarPoster(titulo, anio) {
            const posterStatus = document.getElementById('posterStatus');
            const posterImage = document.getElementById('posterImage');

            posterImage.classList.add('hidden');
            posterStatus.textContent = 'Buscando póster...';

            const queryEs = anio ? `${titulo} ${anio} película` : `${titulo} película`;
            const queryEn = anio ? `${titulo} ${anio} film` : `${titulo} film`;

            const posterUrl =
                (await buscarImagenEnWikipedia('es', queryEs)) ||
                (await buscarImagenEnWikipedia('es', titulo)) ||
                (await buscarImagenEnWikipedia('en', queryEn)) ||
                (await buscarImagenEnWikipedia('en', titulo));

            if (!posterUrl) {
                posterStatus.textContent = 'No se encontró un póster. Prueba con otro título.';
                return;
            }

            posterImage.src = posterUrl;
            posterImage.classList.remove('hidden');
            posterStatus.textContent = '';
        }

        async function buscarImagenEnWikipedia(lang, query) {
            try {
                const searchUrl = `https://${lang}.wikipedia.org/w/api.php?origin=*&action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&srlimit=1`;
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();

                const resultado = searchData?.query?.search?.[0];
                if (!resultado) {
                    return null;
                }

                const pageId = resultado.pageid;
                const imageUrl = `https://${lang}.wikipedia.org/w/api.php?origin=*&action=query&prop=pageimages&pageids=${pageId}&format=json&pithumbsize=600`;
                const imageResponse = await fetch(imageUrl);
                const imageData = await imageResponse.json();

                const page = imageData?.query?.pages?.[pageId];
                return page?.thumbnail?.source || null;
            } catch (error) {
                return null;
            }
        }

        let posterTimeout;
        function programarBusquedaPoster() {
            clearTimeout(posterTimeout);
            posterTimeout = setTimeout(() => {
                const titulo = document.getElementById('titulo').value.trim();
                const anio = document.getElementById('anio').value.trim();

                if (!titulo) {
                    const posterStatus = document.getElementById('posterStatus');
                    const posterImage = document.getElementById('posterImage');
                    posterImage.classList.add('hidden');
                    posterStatus.textContent = 'Escribe el título y el año para ver el póster.';
                    return;
                }

                buscarPoster(titulo, anio);
            }, 600);
        }

        document.getElementById('titulo').addEventListener('input', programarBusquedaPoster);
        document.getElementById('anio').addEventListener('input', programarBusquedaPoster);
        document.getElementById('btnGuardar').addEventListener('click', insertarRegistro);
    </script>
</body>
</html>
